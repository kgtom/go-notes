---


---

<h1 id="高可用问题：">高可用问题：</h1>
<blockquote>
<p>1.事务中不包含外部调用</p>
</blockquote>
<pre><code>事务中是否存在RPC调用、HTTP调用、消息队列操作、缓存、循环查询等耗时的操作，这个操作应该移到事务之外，理想的情况是事务内只处理数据库操作。
</code></pre>
<blockquote>
<p>2.对大事务添加监控报警。大事务发生时，会收到邮件和短信提醒，一般的报警标准是1s。</p>
</blockquote>
<blockquote>
<p>3.设置合适超时时间及重试次数，我们超时&gt;依赖方下游自己的超时，次数 3次。</p>
</blockquote>
<blockquote>
<p>4.容错下游：对于我们依赖的下游要做熔断机制，不能一直死等。</p>
</blockquote>
<blockquote>
<p>5.防御上游：对于依赖于我们的上游要做限流机制，不能毫无节制。压测选取合适的qps.</p>
</blockquote>
<blockquote>
<p>6.code review明白每一段代码含义，弄清楚历史逻辑和临时逻辑</p>
</blockquote>
<blockquote>
<p>7.去依赖，强依赖—&gt;弱化依赖—&gt;异步弱依赖</p>
</blockquote>
<blockquote>
<p>8.慢查询的日志分析</p>
</blockquote>
<ul>
<li>总结：研发规范、自身稳定、容错下游、防御上游。</li>
</ul>
<p>PS:</p>
<p><a href="http://www.zsythink.net/archives/1260">慢查询</a></p>
<p><a href="https://github.com/yangwenmai/ratelimit">限流：漏桶算法、令牌桶算法</a></p>
<p>计数器 是一种简单粗暴方式</p>
<p><a href="http://www.blogjava.net/stevenjohn/archive/2016/06/14/430882.html">总结</a></p>
<p><a href="https://blog.imlibo.com/2016/06/20/golang-token-bucket/">推荐：Golang令牌桶（Token Bucket）限流的实现</a></p>
<pre class=" language-go"><code class="prism  language-go">实现： 最简单的办法是<span class="token keyword">import</span>这个包之后，直接定义一个全局变量：

<span class="token keyword">var</span> tokenBucket <span class="token operator">*</span>ratelimit<span class="token punctuation">.</span>Bucket <span class="token operator">=</span> <span class="token boolean">nil</span>

在<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>中初始化这个变量：

bucketFillDuring <span class="token operator">:=</span> time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">200</span>

bucketMax <span class="token operator">:=</span> <span class="token number">20</span>

tokenBucket <span class="token operator">=</span> ratelimit<span class="token punctuation">.</span><span class="token function">NewBucket</span><span class="token punctuation">(</span>bucketFillDuring<span class="token punctuation">,</span> bucketMax<span class="token punctuation">)</span>

这里两个参数分别是：令牌填充的时间间隔、令牌桶的最大容量。用白话解释就是：我们定义了一个最大容量是<span class="token number">20</span>个令牌的令牌桶，同时每隔<span class="token number">200</span>毫秒向桶中添加一个令牌。也就是说每一个程序实例每秒钟可以处理<span class="token number">5</span>条消息，同时因为桶有<span class="token number">20</span>个容量，所以对突发请求第一秒可以处理<span class="token number">25</span>条消息。那么我们就可以轻易地通过调整开启的实例数量确定当前系统的流量限制了。

下面就是限流了。有了这个桶之后在真正开始处理数据之前，可以很简单实现判断是否要对这次处理进行丢弃（被限流）：

available <span class="token operator">:=</span> tokenBucket<span class="token punctuation">.</span><span class="token function">TakeAvailable</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> available <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>

<span class="token comment">/*** 限流处理 ***/</span>

<span class="token punctuation">}</span>

这里就可以简单理解了：在程序真正处理之前，从桶中拿出<span class="token number">1</span>个令牌，如果成功了，就继续，如果没成功（返回<span class="token number">0</span>），那么就触发限流，回复：“系统繁忙，请稍候再试。”
<span class="token string">``</span>

<span class="token operator">&gt;</span> sql耗时分析：https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>chenjiacheng<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">6877400.</span>html

总结：<span class="token number">1</span>、大表 左关联 小表，很慢；小表 左关联 大表，很快。<span class="token number">2</span>、走出自身的思想误区，应对底层有深入理解才能正确使用。

reference<span class="token punctuation">:</span>
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>mp<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com<span class="token operator">/</span>s<span class="token operator">/</span>fx6XfBpuzozsJCvllMcCqw
</code></pre>

